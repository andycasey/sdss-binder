name: Auto-merge SDSS Organization PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Check if author is SDSS contributor
        id: check_member
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Check if the PR author has commits in any sdss organization repo
          # (org membership API is restricted, so we check contribution history)
          commit_count=$(gh api search/commits -X GET -f q="author:$PR_AUTHOR org:sdss" --jq '.total_count' 2>/dev/null || echo "0")
          if [ "$commit_count" -gt "0" ]; then
            echo "is_member=true" >> $GITHUB_OUTPUT
            echo "‚úÖ $PR_AUTHOR has $commit_count commits in sdss repositories"
          else
            echo "is_member=false" >> $GITHUB_OUTPUT
            echo "‚ùå $PR_AUTHOR has no commits in sdss repositories"
          fi

      - name: Auto-merge PR
        if: steps.check_member.outputs.is_member == 'true' && github.event.pull_request.draft == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Auto-merging PR #$PR_NUMBER from SDSS contributor"
          gh pr merge $PR_NUMBER --repo $REPO --squash

      - name: Add comment
        if: steps.check_member.outputs.is_member == 'true' && github.event.pull_request.draft == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          gh pr comment $PR_NUMBER --repo $REPO --body "ü§ñ Auto-merge enabled for SDSS contributor. PR will merge automatically when all checks pass."
